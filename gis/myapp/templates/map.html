{% extends "base.html" %} {% block title %} B·∫£n ƒë·ªì CƒÉn h·ªô TP.HCM {% endblock %}
{% block content_wrapper %}
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>

<style>
  .user-pulse-icon {
    background-color: #4285f4;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 3px solid white;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
    position: relative;
    z-index: 2;
  }
  .user-pulse-icon::after {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 100%;
    height: 100%;
    border-radius: 50%;
    background-color: rgba(66, 133, 244, 0.6);
    animation: pulse-ring 2s infinite;
    z-index: -1;
  }
  @keyframes pulse-ring {
    0% {
      width: 100%;
      height: 100%;
      opacity: 0.8;
    }
    100% {
      width: 400%;
      height: 400%;
      opacity: 0;
    }
  }
  .distance-tooltip {
    background-color: #fff;
    border: 2px solid #dc3545;
    color: #dc3545;
    font-weight: bold;
    padding: 4px 10px;
    border-radius: 20px;
  }
  .leaflet-tooltip-left:before,
  .leaflet-tooltip-right:before {
    border: none !important;
  }
  .leaflet-interactive {
    cursor: pointer;
  }

  .info-floating-box {
    background: white;
    padding: 10px 15px;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
    text-align: center;
    border-left: 5px solid #4285f4;
    min-width: 120px;
  }
  .info-dist {
    font-size: 20px;
    font-weight: bold;
    color: #d93025;
  }
</style>

<div class="main-container">
  <div class="sidebar-panel">
    <div style="padding: 15px; border-bottom: 1px solid #eee">
      <h4 class="mb-0 text-primary">
        <i class="fas fa-map-marked-alt"></i> Thu√™ Nh√† S√†i G√≤n
      </h4>
      <small id="status-msg" class="text-warning">
        <i class="fas fa-spinner fa-spin"></i> ƒêang t√¨m v·ªã tr√≠...
      </small>
    </div>

    <div id="listing-panel" class="scrollable-content">
      {% for item in apartments %}
      <div
        class="apt-card"
        id="card-{{ item.id }}"
        onclick="focusApartment({{ item.lat|stringformat:'f' }}, {{ item.lng|stringformat:'f' }}, {{ item.id }})"
      >
        {% if item.image %}
        <img src="{{ item.image }}" class="apt-img" alt="House" />
        {% else %}
        <img
          src="https://images.unsplash.com/photo-1522708323590-d24dbb6b0267"
          class="apt-img"
          alt="House"
        />
        {% endif %}
        <div class="apt-details">
          <div class="d-flex justify-content-between">
            <span class="apt-price">{{ item.price }}‚Ç´ <small>/ƒë√™m</small></span>
            <span class="badge badge-success">C√≤n ph√≤ng</span>
          </div>
          <h5 class="apt-name">{{ item.name }}</h5>
          <p class="apt-address">
            <i class="fas fa-map-marker-alt"></i> {{ item.address }}
          </p>
          <div class="apt-actions">
            <button
              class="btn btn-outline-primary btn-sm flex-grow-1"
              onclick="event.stopPropagation(); prepareRoute({{ item.lat|stringformat:'f' }}, {{ item.lng|stringformat:'f' }}, '{{ item.name }}')"
            >
              <i class="fas fa-route"></i> Ch·ªâ ƒë∆∞·ªùng
            </button>
            <a
              href="{% url 'apartment_detail' item.id %}"
              class="btn btn-primary btn-sm ml-2"
            >
              <i class="fas fa-info-circle"></i>
            </a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <div
      id="direction-panel"
      style="display: none; flex-direction: column; padding: 15px; height: 100%"
    >
      <button class="back-btn" onclick="closeDirectionPanel()">
        <i class="fas fa-arrow-left"></i> Quay l·∫°i
      </button>
      <h5 class="mb-1 mt-2">
        ƒê·∫øn: <span id="dest-title" class="text-primary">...</span>
      </h5>
      <div class="transport-options mb-3">
        <button class="t-btn active" onclick="changeMode('driving')">
          üöó √î t√¥
        </button>
        <button class="t-btn" onclick="changeMode('cycling')">üõµ Xe m√°y</button>
        <button class="t-btn" onclick="changeMode('walking')">üö∂ ƒêi b·ªô</button>
      </div>
      <div id="loading-box" class="text-center py-3" style="display: none">
        <div class="spinner-border text-primary" role="status"></div>
        <p>ƒêang t√¨m ƒë∆∞·ªùng...</p>
      </div>
      <div
        id="error-box"
        class="alert alert-danger"
        style="display: none"
      ></div>
      <div
        id="routes-list"
        class="list-group overflow-auto"
        style="flex: 1"
      ></div>
    </div>
  </div>

  <div class="map-wrapper"><div id="map"></div></div>
</div>
<script>
  const DEFAULT_LAT = 10.7721; const DEFAULT_LNG = 106.6983;
  var map = L.map('map').setView([DEFAULT_LAT, DEFAULT_LNG], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OpenStreetMap' }).addTo(map);

  var userLocation = null; var userMarker = null;
  var currentDest = null; var currentMode = 'driving';
  var apartments = {{ apartments|safe }};
  var currentRouteLayers = []; var distanceLabels = []; var infoControl = null; var routesData = [];

  var blueIcon = new L.Icon({
      iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',
      shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
      iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34]
  });

  apartments.forEach(apt => {
      L.marker([apt.lat, apt.lng], {icon: blueIcon}).addTo(map)
       .bindPopup(`<b>${apt.name}</b><br><button class="btn btn-sm btn-primary mt-1" onclick="prepareRoute(${apt.lat}, ${apt.lng}, '${apt.name}')">Ch·ªâ ƒë∆∞·ªùng</button>`);
  });
  // 3. G·ªåI API PYTHON
  function callPythonAPI() {
      if (!userLocation || !currentDest) return;
      document.getElementById('loading-box').style.display = 'block';
      document.getElementById('routes-list').innerHTML = '';
      document.getElementById('error-box').style.display = 'none';

      currentRouteLayers.forEach(l => map.removeLayer(l)); currentRouteLayers = [];
      distanceLabels.forEach(l => map.removeLayer(l)); distanceLabels = [];
      if (infoControl) { map.removeControl(infoControl); infoControl = null; }

      var url = `/api/route/?start_lat=${userLocation.lat}&start_lng=${userLocation.lng}&end_lat=${currentDest.lat}&end_lng=${currentDest.lng}&mode=${currentMode}`;

      fetch(url).then(res => res.json()).then(data => {
          document.getElementById('loading-box').style.display = 'none';
          if (data.error || !data.routes) {
              document.getElementById('error-box').innerText = data.error || "Kh√¥ng th·∫•y ƒë∆∞·ªùng.";
              document.getElementById('error-box').style.display = 'block';
              return;
          }
          routesData = data.routes;
          routesData.forEach((route, index) => {
              var isMain = (index === 0);
              var color = isMain ? '#4285F4' : '#9aa0a6';
              var weight = isMain ? 7 : 4;

              var polyline = L.polyline(route.route_points, {color: color, weight: weight}).addTo(map);
              polyline.on('click', () => selectRoute(index));
              currentRouteLayers.push(polyline);

              if (isMain) drawLabelAndInfo(route);

              var isActive = isMain ? 'active' : '';
              var itemHtml = `
                  <a href="#" onclick="selectRoute(${index}); return false;" class="list-group-item list-group-item-action ${isActive}">
                      <div class="d-flex w-100 justify-content-between">
                          <h6 class="mb-1">C√°ch ${index + 1}: ${route.summary}</h6>
                          <small>${route.duration_min} ph√∫t</small>
                      </div>
                      <p class="mb-1 text-danger font-weight-bold">${route.distance_km} km</p>
                  </a>`;
              document.getElementById('routes-list').insertAdjacentHTML('beforeend', itemHtml);
          });
          map.fitBounds(currentRouteLayers[0].getBounds(), {padding: [50, 50]});
      }).catch(err => console.error(err));
  }

  function drawLabelAndInfo(route) {
      var midPoint = route.route_points[Math.floor(route.route_points.length / 2)];
      var tooltip = L.tooltip({permanent: true, direction: 'center', className: 'distance-tooltip'})
          .setContent(`${route.distance_km} km`).setLatLng(midPoint).addTo(map);
      distanceLabels.push(tooltip);

      if (infoControl) map.removeControl(infoControl);
      infoControl = L.control({position: 'topright'});
      infoControl.onAdd = function (map) {
          var div = L.DomUtil.create('div', 'info-floating-box');
          div.innerHTML = `<div class="info-dist">${route.distance_km} km</div><div class="info-time">${route.duration_min} ph√∫t</div>`;
          return div;
      };
      infoControl.addTo(map);
  }

  function selectRoute(selectedIndex) {
      currentRouteLayers.forEach((layer, index) => {
          var isSelected = (index === selectedIndex);
          layer.setStyle({ color: isSelected ? '#4285F4' : '#9aa0a6', weight: isSelected ? 7 : 4 });
          if (isSelected) layer.bringToFront();
      });
      distanceLabels.forEach(l => map.removeLayer(l)); distanceLabels = [];
      drawLabelAndInfo(routesData[selectedIndex]);

      var items = document.querySelectorAll('#routes-list a');
      items.forEach((item, index) => {
          if (index === selectedIndex) item.classList.add('active'); else item.classList.remove('active');
      });
  }

  // 4. KI·ªÇM TRA URL (target_id)
  function checkUrlForAutoRoute() {
      const urlParams = new URLSearchParams(window.location.search);
      const targetId = urlParams.get('target_id');
      if (targetId) {
          const targetApt = apartments.find(a => a.id == targetId);
          if (targetApt) {
              prepareRoute(targetApt.lat, targetApt.lng, targetApt.name);
              window.history.replaceState({}, document.title, window.location.pathname);
          }
      }
  }

  function changeMode(mode) { currentMode = mode; var btns = document.querySelectorAll('.t-btn'); btns.forEach(b => b.classList.remove('active')); event.target.classList.add('active'); callPythonAPI(); }

  function closeDirectionPanel() {
      document.getElementById('direction-panel').style.display = 'none';
      document.getElementById('listing-panel').style.display = 'block';
      currentRouteLayers.forEach(l => map.removeLayer(l));
      distanceLabels.forEach(l => map.removeLayer(l));
      if (infoControl) map.removeControl(infoControl);
      map.setView([userLocation.lat, userLocation.lng], 13);
  }

  function focusApartment(lat, lng, id) { map.flyTo([lat, lng], 15); }

  // Ch·∫°y ki·ªÉm tra ngay khi load
  checkUrlForAutoRoute();
</script>
{% endblock %}
